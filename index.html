<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€’æ•¸è¨ˆæ™‚å·¥å…·</title>
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #007bff; font-size: 1.2rem; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { width: 50%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1.1rem; text-align: center; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        button:disabled { background: #ccc; }
        button.stop { background: #dc3545; margin-top: 10px; }
        
        .display-area { text-align: center; margin: 20px 0; }
        .countdown { font-size: 3rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .target-time { color: #666; font-size: 0.9rem; margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; }
        th { color: #888; font-weight: normal; }
        .clear-btn { background: none; border: none; color: #dc3545; font-size: 0.8rem; padding: 0; width: auto; float: right; }
    </style>
</head>
<body>

    <div class="card">
        <h2>â±ï¸ å€’æ•¸è¨ˆæ™‚è¨­å®š</h2>
        <div class="input-group">
            <input type="number" id="inputHours" placeholder="å°æ™‚" min="0">
            <input type="number" id="inputMinutes" placeholder="åˆ†é˜" min="0">
        </div>
        <button id="startBtn" onclick="initiateTimer()">é–‹å§‹å€’æ•¸</button>
        <button id="stopBtn" class="stop" onclick="stopTimerManual()" style="display:none;">åœæ­¢/é‡ç½®</button>

        <div class="display-area">
            <div class="countdown" id="display">00:00:00</div>
            <div class="target-time" id="targetDisplay">è«‹è¼¸å…¥æ™‚é–“ä¸¦é–‹å§‹</div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ æ­·å²è¨˜éŒ„ <button class="clear-btn" onclick="clearHistory()">æ¸…é™¤</button></h2>
        <table>
            <thead>
                <tr>
                    <th>é–‹å§‹</th>
                    <th>çµæŸ</th>
                    <th>æ™‚é•·</th>
                </tr>
            </thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>

    <script>
        let countdownInterval;
        const historyData = JSON.parse(localStorage.getItem('timerHistory')) || [];

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = function() {
            renderHistory();
            checkActiveTimer(); // æª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨é€²è¡Œçš„å€’æ•¸
        };

        function checkActiveTimer() {
            const savedTarget = localStorage.getItem('activeTimerTarget');
            const savedDurationStr = localStorage.getItem('activeTimerDurationStr');
            const savedStartTime = localStorage.getItem('activeTimerStartTime');

            if (savedTarget) {
                const now = new Date().getTime();
                const targetTime = parseInt(savedTarget);
                const remainingSeconds = Math.floor((targetTime - now) / 1000);

                if (remainingSeconds > 0) {
                    // å€’æ•¸é‚„æ²’çµæŸï¼Œç¹¼çºŒè·‘
                    lockUI(true);
                    document.getElementById('targetDisplay').innerText = `ç›®æ¨™çµæŸæ™‚é–“: ${formatTime(new Date(targetTime))}`;
                    startCountdownLogic(remainingSeconds);
                } else {
                    // é é¢é—œé–‰æœŸé–“å€’æ•¸å·²ç¶“çµæŸäº†
                    lockUI(false);
                    document.getElementById('display').innerText = "æ™‚é–“åˆ°ï¼";
                    // æ¸…é™¤é–å®šç‹€æ…‹ä½†ä¿ç•™æ­·å²è¨˜éŒ„
                    localStorage.removeItem('activeTimerTarget');
                }
            }
        }

        function initiateTimer() {
            const hrs = parseInt(document.getElementById('inputHours').value) || 0;
            const mins = parseInt(document.getElementById('inputMinutes').value) || 0;

            if (hrs === 0 && mins === 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ™‚é–“ï¼");
                return;
            }

            const now = new Date();
            const totalSeconds = (hrs * 3600) + (mins * 60);
            const targetTimeMs = now.getTime() + (totalSeconds * 1000);
            const endTime = new Date(targetTimeMs);
            const durationStr = `${hrs}æ™‚${mins}åˆ†`;

            // 1. å„²å­˜ç‹€æ…‹åˆ° LocalStorage (é—œéµæ­¥é©Ÿ)
            localStorage.setItem('activeTimerTarget', targetTimeMs);
            localStorage.setItem('activeTimerDurationStr', durationStr);
            localStorage.setItem('activeTimerStartTime', now.getTime());

            // 2. å¯«å…¥æ­·å²è¨˜éŒ„
            addToHistory(now, endTime, durationStr);

            // 3. æ›´æ–° UI èˆ‡é–‹å§‹å€’æ•¸
            document.getElementById('targetDisplay').innerText = `ç›®æ¨™çµæŸæ™‚é–“: ${formatTime(endTime)}`;
            lockUI(true);
            startCountdownLogic(totalSeconds);
        }

        function startCountdownLogic(seconds) {
            updateDisplay(seconds);
            let remaining = seconds;
            
            // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨ä»¥é˜²è¬ä¸€
            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                remaining--;
                if (remaining < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('display').innerText = "æ™‚é–“åˆ°ï¼";
                    localStorage.removeItem('activeTimerTarget'); // ç§»é™¤æ´»èºç‹€æ…‹
                    lockUI(false); // è§£é–æŒ‰éˆ•
                    // é€™è£¡å¯ä»¥åŠ å…¥æ’­æ”¾éŸ³æ•ˆ
                } else {
                    updateDisplay(remaining);
                }
            }, 1000);
        }

        function stopTimerManual() {
            stopTimer(); // åœæ­¢è¨ˆæ™‚
            document.getElementById('display').innerText = "å·²åœæ­¢";
            document.getElementById('targetDisplay').innerText = "å·²æ‰‹å‹•åœæ­¢";
        }

        function stopTimer() {
            clearInterval(countdownInterval);
            localStorage.removeItem('activeTimerTarget'); // æ¸…é™¤æ´»èºç‹€æ…‹
            lockUI(false);
        }

        function lockUI(isLocked) {
            document.getElementById('startBtn').style.display = isLocked ? 'none' : 'block';
            document.getElementById('stopBtn').style.display = isLocked ? 'block' : 'none';
            document.getElementById('inputHours').disabled = isLocked;
            document.getElementById('inputMinutes').disabled = isLocked;
            if(!isLocked) {
                // å¦‚æœéœ€è¦é‡ç½®è¼¸å…¥æ¡†å¯è§£é–‹ä¸‹é¢é€™è¡Œ
                // document.getElementById('inputHours').value = ''; 
            }
        }

        function updateDisplay(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            document.getElementById('display').innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function addToHistory(start, end, duration) {
            const record = {
                start: formatTime(start),
                end: formatTime(end),
                duration: duration
            };
            historyData.unshift(record);
            localStorage.setItem('timerHistory', JSON.stringify(historyData));
            renderHistory();
        }

        function renderHistory() {
            const tbody = document.getElementById('historyList');
            tbody.innerHTML = '';
            historyData.forEach(item => {
                tbody.innerHTML += `<tr><td>${item.start}</td><td>${item.end}</td><td>${item.duration}</td></tr>`;
            });
        }

        function clearHistory() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿ")) {
                localStorage.removeItem('timerHistory');
                historyData.length = 0;
                renderHistory();
            }
        }

        function formatTime(date) {
            return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }
    </script>
</body>

</html>
