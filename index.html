<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”ŸçŒ›TIMER2026 é›²ç«¯åŒæ­¥ç‰ˆ â˜ï¸</title>

    <link rel="manifest" href="manifest.json?v=memory1">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background: #f0f2f5; 
            color: #333; 
            max-width: 600px;
            margin: 0 auto;
        }
        
        .main-title {
            text-align: center;
            font-size: 1.6rem;
            font-weight: bold;
            color: #333;
            margin-top: 10px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .gif-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .gif-image {
            width: 100%;
            max-height: 500px;  
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        
        h2 { margin-top: 0; color: #007bff; font-size: 1.2rem; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { 
            width: 50%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            font-size: 1.2rem; 
            text-align: center; 
            font-weight: bold;
            color: #333;
        }
        
        button { 
            width: 100%; 
            padding: 12px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1rem; 
            font-weight: bold;
            cursor: pointer; 
            transition: background 0.2s;
        }
        button:active { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.stop { background: #dc3545; margin-top: 10px; }
        button.stop:active { background: #a71d2a; }
        
        .display-area { text-align: center; margin: 25px 0; }
        .countdown { 
            font-size: 3.5rem; 
            font-weight: bold; 
            font-variant-numeric: tabular-nums; 
            color: #222;
        }
        .target-time { color: #666; font-size: 1rem; margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 10px 5px; border-bottom: 1px solid #eee; }
        th { color: #888; font-weight: normal; }
        .clear-btn { 
            background: none; 
            border: 1px solid #dc3545; 
            color: #dc3545; 
            font-size: 0.8rem; 
            padding: 4px 10px; 
            width: auto; 
            float: right; 
            border-radius: 4px;
            cursor: pointer;
        }
        .clear-btn:hover { background: #dc3545; color: white; }
    </style>
</head>
<body>

    <h1 class="main-title">ğŸš€ ç”ŸçŒ›TIMER2026 é›²ç«¯åŒæ­¥ç‰ˆ</h1>

    <div class="gif-container">
        <video class="gif-image" autoplay loop muted playsinline>
            <source src="banner.mp4" type="video/mp4">
        </video>
    </div>

    <div class="card">
        <h2>â±ï¸ å€’æ•¸è¨ˆæ™‚è¨­å®š</h2>
        <div class="input-group">
            <input type="number" id="inputHours" placeholder="å°æ™‚" min="0">
            <input type="number" id="inputMinutes" placeholder="åˆ†é˜" min="0">
        </div>
        <button id="startBtn" onclick="initiateTimer()">é–‹å§‹å€’æ•¸</button>
        <button id="stopBtn" class="stop" onclick="stopTimerManual()" style="display:none;">åœæ­¢/é‡ç½®</button>

        <div class="display-area">
            <div class="countdown" id="display">00:00:00</div>
            <div class="target-time" id="targetDisplay">è«‹è¼¸å…¥æ™‚é–“ä¸¦é–‹å§‹</div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ æ­·å²è¨˜éŒ„ <button class="clear-btn" onclick="clearHistory()">æ¸…é™¤è¨˜éŒ„</button></h2>
        <table>
            <thead>
                <tr>
                    <th>é–‹å§‹</th>
                    <th>çµæŸ</th>
                    <th>æ™‚é•·</th>
                </tr>
            </thead>
            <tbody id="historyList"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // ä½ çš„å°ˆå±¬ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCpvWFN3JHzm-Zs9Ngk3uUTHL9uSybvlPE",
            authDomain: "timer2026-f0ae3.firebaseapp.com",
            databaseURL: "https://timer2026-f0ae3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "timer2026-f0ae3",
            storageBucket: "timer2026-f0ae3.firebasestorage.app",
            messagingSenderId: "33784124481",
            appId: "1:33784124481:web:796e9d9c8fdbb9549c22c0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // å…©å€‹é›²ç«¯æˆ¿é–“
        const timerRef = ref(db, 'timerState'); 
        const historyRef = ref(db, 'history');  

        let countdownInterval;

        window.onload = function() {
            // è®€å–ä¸Šæ¬¡è¼¸å…¥çš„æ•¸å­—ä¸¦å¡«å…¥
            const lastHours = localStorage.getItem('lastInputHours');
            const lastMinutes = localStorage.getItem('lastInputMinutes');
            if (lastHours !== null) document.getElementById('inputHours').value = lastHours;
            if (lastMinutes !== null) document.getElementById('inputMinutes').value = lastMinutes;
        };

        // é›²ç«¯ç›£è½å™¨ 1ï¼šç›£è½è¨ˆæ™‚å™¨ç‹€æ…‹
        onValue(timerRef, (snapshot) => {
            const data = snapshot.val();
            
            if (data && data.status === 'running') {
                const now = new Date().getTime();
                const remainingSeconds = Math.floor((data.targetTimeMs - now) / 1000);

                if (remainingSeconds > 0) {
                    lockUI(true);
                    document.getElementById('targetDisplay').innerText = `ç›®æ¨™çµæŸæ™‚é–“: ${formatTime(new Date(data.targetTimeMs))}`;
                    startCountdownLogic(data.targetTimeMs);
                } else {
                    lockUI(false);
                    document.getElementById('display').innerText = "æ™‚é–“åˆ°ï¼";
                    document.getElementById('targetDisplay').innerText = "ç­‰å¾…æ–°ä»»å‹™...";
                    stopTimerLocal();
                }
            } else if (data && data.status === 'stopped') {
                lockUI(false);
                document.getElementById('display').innerText = "å·²åœæ­¢";
                document.getElementById('targetDisplay').innerText = "å·²æ‰‹å‹•åœæ­¢";
                stopTimerLocal();
            } else {
                lockUI(false);
                document.getElementById('display').innerText = "00:00:00";
                document.getElementById('targetDisplay').innerText = "è«‹è¼¸å…¥æ™‚é–“ä¸¦é–‹å§‹";
                stopTimerLocal();
            }
        });

        // é›²ç«¯ç›£è½å™¨ 2ï¼šç›£è½æ­·å²è¨˜éŒ„
        onValue(historyRef, (snapshot) => {
            const data = snapshot.val();
            const tbody = document.getElementById('historyList');
            tbody.innerHTML = ''; 
            
            if (data) {
                // å°‡ç‰©ä»¶è½‰æ›æˆé™£åˆ—ä¸¦åè½‰ (æœ€æ–°æ’æœ€é ‚)
                const records = Object.values(data).reverse();
                
                // é¡¯ç¤ºæœ€æ–° 10 ç­†è¨˜éŒ„
                records.slice(0, 10).forEach(item => {
                    tbody.innerHTML += `<tr><td>${item.start}</td><td>${item.end}</td><td>${item.duration}</td></tr>`;
                });
            }
        });

        // é–‹å§‹å€’æ•¸
        window.initiateTimer = function() {
            const hrs = parseInt(document.getElementById('inputHours').value) || 0;
            const mins = parseInt(document.getElementById('inputMinutes').value) || 0;

            if (hrs === 0 && mins === 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ™‚é–“ï¼");
                return;
            }

            // è¨˜éŒ„ä¸Šæ¬¡è¼¸å…¥çš„æ™‚é–“åˆ°æœ¬åœ°
            localStorage.setItem('lastInputHours', hrs);
            localStorage.setItem('lastInputMinutes', mins);

            const now = new Date();
            const totalSeconds = (hrs * 3600) + (mins * 60);
            const targetTimeMs = now.getTime() + (totalSeconds * 1000);
            const durationStr = `${hrs}æ™‚${mins}åˆ†`;

            // å°‡æ–°è¨˜éŒ„æ¨ä¸Šé›²ç«¯
            addToHistory(now, new Date(targetTimeMs), durationStr);

            // å¯«å…¥é›²ç«¯è¨ˆæ™‚å™¨æˆ¿é–“
            set(timerRef, {
                status: 'running',
                targetTimeMs: targetTimeMs
            });
        };

        // æ‰‹å‹•åœæ­¢
        window.stopTimerManual = function() {
            set(timerRef, {
                status: 'stopped',
                targetTimeMs: 0
            });
        };

        // å€’æ•¸é‚è¼¯
        function startCountdownLogic(targetTimeMs) {
            if (countdownInterval) clearInterval(countdownInterval);

            const updateClock = () => {
                const now = new Date().getTime();
                const remaining = Math.floor((targetTimeMs - now) / 1000);
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('display').innerText = "æ™‚é–“åˆ°ï¼";
                    lockUI(false);
                } else {
                    updateDisplay(remaining);
                }
            };
            
            updateClock();
            countdownInterval = setInterval(updateClock, 1000);
        }

        function stopTimerLocal() {
            if (countdownInterval) clearInterval(countdownInterval);
        }

        // é–å®š/è§£é–ä»‹é¢
        function lockUI(isLocked) {
            document.getElementById('startBtn').style.display = isLocked ? 'none' : 'block';
            document.getElementById('stopBtn').style.display = isLocked ? 'block' : 'none';
            document.getElementById('inputHours').disabled = isLocked;
            document.getElementById('inputMinutes').disabled = isLocked;
        }

        function updateDisplay(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            document.getElementById('display').innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        // å°‡è¨˜éŒ„åŠ å…¥é›²ç«¯
        function addToHistory(start, end, duration) {
            const record = {
                start: formatTime(start),
                end: formatTime(end),
                duration: duration,
                timestamp: new Date().getTime() 
            };
            push(historyRef, record);
        }

        // æ¸…é™¤é›²ç«¯è¨˜éŒ„
        window.clearHistory = function() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿæ­¤å‹•ä½œæœƒåŒæ™‚æ¸…ç©ºæ‰€æœ‰è£ç½®çš„è¨˜éŒ„ï¼")) {
                remove(historyRef);
            }
        };

        // æ™‚é–“æ ¼å¼åŒ–å·¥å…·
        function formatTime(date) {
            return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }
    </script>
</body>
</html>
